# üéâ Production-ready Payment Flow

## –©–æ –∑–º—ñ–Ω–∏–ª–æ—Å—è

### ‚úÖ –ü–æ–≤–Ω–∏–π –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–π –ø–æ—Ç—ñ–∫ –æ–ø–ª–∞—Ç–∏:

1. **–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –Ω–∞—Ç–∏—Å–∫–∞—î `/pay` –∞–±–æ –∫–Ω–æ–ø–∫—É "–ö—É–ø–∏—Ç–∏ –∫—É—Ä—Å"**
2. **–ë–æ—Ç —Ñ–æ—Ä–º—É—î URL** –∑ `tg_id`: `https://gluckenkurs-bot.onrender.com/pay?tg_id=123456789`
3. **Stripe Checkout** –æ—Ç—Ä–∏–º—É—î `tg_id` –≤ metadata
4. **–ü—ñ—Å–ª—è —É—Å–ø—ñ—à–Ω–æ—ó –æ–ø–ª–∞—Ç–∏** Stripe webhook:
   - –ü–æ–∑–Ω–∞—á–∞—î `is_paid=1` –≤ –ë–î
   - **–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –Ω–∞–¥—Å–∏–ª–∞—î —ñ–Ω–≤–∞–π—Ç-–ª—ñ–Ω–∫** –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É –≤ Telegram

---

## üìÅ –ó–º—ñ–Ω–µ–Ω—ñ —Ñ–∞–π–ª–∏

### 1. `app/web/server.py`
- **–ë—É–ª–æ:** `/pay?user_id=123` (—Å—Ç–∞—Ä–∏–π –ø–∞—Ä–∞–º–µ—Ç—Ä)
- **–°—Ç–∞–ª–æ:** `/pay?tg_id=123` (–Ω–æ–≤–∏–π –ø–∞—Ä–∞–º–µ—Ç—Ä)
- –Ø–∫—â–æ `tg_id` –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω–æ ‚Üí –ø–æ–º–∏–ª–∫–∞ 400
- Metadata: `{"tg_id": "123456789"}`

### 2. `app/web/stripe_webhook.py`
- **–î–æ–¥–∞–Ω–æ:** `_notify_user()` ‚Äî –Ω–∞–¥—Å–∏–ª–∞—î –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è —á–µ—Ä–µ–∑ Telegram Bot API
- **–ü—ñ—Å–ª—è –æ–ø–ª–∞—Ç–∏:**
  1. `mark_paid(user_id, session_id)` ‚Äî –ø–æ–∑–Ω–∞—á–∞—î –≤ –ë–î
  2. `_notify_user(tg_id, text)` ‚Äî –Ω–∞–¥—Å–∏–ª–∞—î —ñ–Ω–≤–∞–π—Ç-–ª—ñ–Ω–∫
- **–¢–µ–∫—Å—Ç –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è:**
  ```
  üéâ –û–ø–ª–∞—Ç—É –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–æ!
  
  –í—ñ—Ç–∞—î–º–æ —É –∑–∞–∫—Ä–∏—Ç–æ–º—É –∫—É—Ä—Å—ñ ¬´10 –∫—Ä–æ–∫—ñ–≤ –¥–æ —â–∞—Å—Ç—è¬ª.
  –ü—Ä–∏—î–¥–Ω—É–π—Ç–µ—Å—å –¥–æ –ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ –∫–∞–Ω–∞–ª—É –∑ —É—Ä–æ–∫–∞–º–∏:
  
  üîó https://t.me/+BVlgP_AqpcowYTcy
  
  –Ø–∫—â–æ –ø–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–µ –≤—ñ–¥–∫—Ä–∏–≤–∞—î—Ç—å—Å—è ‚Äî –Ω–∞–ø–∏—à—ñ—Ç—å /help —É –±–æ—Ç.
  
  üí¨ Coach Agent –≥–æ—Ç–æ–≤–∏–π –≤—ñ–¥–ø–æ–≤—ñ—Å—Ç–∏ –Ω–∞ —Ç–≤–æ—ó –ø–∏—Ç–∞–Ω–Ω—è –ø—Ä–æ —É—Ä–æ–∫–∏!
  ```

### 3. `app/bot/handlers/buy.py`
- **–ö–æ–º–∞–Ω–¥–∞ `/pay`:**
  - –§–æ—Ä–º—É—î URL: `/pay?tg_id={user_id}`
  - –ü–æ–∫–∞–∑—É—î –ø—Ä—è–º–∏–π –ª—ñ–Ω–∫ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É
- **Callback "buy":**
  - –û–Ω–æ–≤–ª–µ–Ω–∞ –∫–Ω–æ–ø–∫–∞ "üí≥ –ü–µ—Ä–µ–π—Ç–∏ –¥–æ –æ–ø–ª–∞—Ç–∏" –∑ –Ω–æ–≤–∏–º URL

---

## üîß –ó–º—ñ–Ω–Ω—ñ –æ—Ç–æ—á–µ–Ω–Ω—è

### –î–æ–¥–∞–Ω–æ –Ω–æ–≤—É –∑–º—ñ–Ω–Ω—É:

```env
PAID_CHANNEL_LINK=https://t.me/+BVlgP_AqpcowYTcy
```

### Render Dashboard:
1. –Ü–¥–∏ –Ω–∞ https://dashboard.render.com/
2. –í–∏–±–µ—Ä–∏ **glucklichkurs-bot** ‚Üí Environment
3. –î–æ–¥–∞–π:
   - Key: `PAID_CHANNEL_LINK`
   - Value: `https://t.me/+BVlgP_AqpcowYTcy`

---

## üß™ –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è

### –õ–æ–∫–∞–ª—å–Ω–æ:

1. –ó–∞–ø—É—Å—Ç–∏ FastAPI:
   ```bash
   uvicorn app.web.server:app --reload --port 8000
   ```

2. –ó–∞–ø—É—Å—Ç–∏ –±–æ—Ç–∞ (—ñ–Ω—à–∏–π —Ç–µ—Ä–º—ñ–Ω–∞–ª):
   ```bash
   python -m app.bot.main
   ```

3. –ù–∞–ø–∏—à–∏ –±–æ—Ç—É `/pay`

4. –ü–µ—Ä–µ–π–¥–∏ –∑–∞ –ª—ñ–Ω–∫–æ–º ‚Üí –æ–ø–ª–∞—Ç–∞ —á–µ—Ä–µ–∑ Stripe (—Ç–µ—Å—Ç–æ–≤–∏–π —Ä–µ–∂–∏–º)

5. –ü—ñ—Å–ª—è –æ–ø–ª–∞—Ç–∏ –ø–µ—Ä–µ–≤—ñ—Ä:
   - –ë–î: `is_paid=1`
   - Telegram: –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∑ —ñ–Ω–≤–∞–π—Ç-–ª—ñ–Ω–∫–æ–º

---

### –ù–∞ Render:

1. Commit + push ‚Üí auto-deploy
2. –ù–∞–ø–∏—à–∏ –±–æ—Ç—É `/pay`
3. –û–ø–ª–∞—Ç–∞ ‚Üí webhook —Å–ø—Ä–∞—Ü—é—î –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ
4. –û—Ç—Ä–∏–º–∞—î—à –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∑ –ª—ñ–Ω–∫–æ–º

---

## üéØ –ö–æ—Ä–∏—Å—Ç—É–≤–∞—Ü—å–∫–∏–π –¥–æ—Å–≤—ñ–¥

### –î–æ –∑–º—ñ–Ω:
```
–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á ‚Üí /pay ‚Üí Stripe ‚Üí "–î—è–∫—É—î–º–æ –∑–∞ –æ–ø–ª–∞—Ç—É" ‚Üí ???
(—Ç—Ä–µ–±–∞ –≤—Ä—É—á–Ω—É –Ω–∞–¥—Å–∏–ª–∞—Ç–∏ –ª—ñ–Ω–∫)
```

### –ü—ñ—Å–ª—è –∑–º—ñ–Ω:
```
–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á ‚Üí /pay ‚Üí Stripe ‚Üí Webhook ‚Üí üéâ –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∑ –ª—ñ–Ω–∫–æ–º
```

‚úÖ **–ü–æ–≤–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü—ñ—è!**

---

## üìä –ú–µ—Ç—Ä–∏–∫–∏

- **–ß–∞—Å –¥–æ—Å—Ç–∞–≤–∫–∏ —ñ–Ω–≤–∞–π—Ç-–ª—ñ–Ω–∫—É:** 2-5 —Å–µ–∫—É–Ω–¥ –ø—ñ—Å–ª—è –æ–ø–ª–∞—Ç–∏
- **–ù–∞–¥—ñ–π–Ω—ñ—Å—Ç—å:** Webhook Stripe (99.9% uptime)
- **Fallback:** –Ø–∫—â–æ webhook –Ω–µ —Å–ø—Ä–∞—Ü—é—î, –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –º–æ–∂–µ –Ω–∞–ø–∏—Å–∞—Ç–∏ `/help`

---

## üîê –ë–µ–∑–ø–µ–∫–∞

1. **Webhook signature validation** ‚Äî Stripe –ø–µ—Ä–µ–≤—ñ—Ä—è—î –ø—ñ–¥–ø–∏—Å
2. **tg_id –≤ metadata** ‚Äî –∑–∞—Ö–∏—â–µ–Ω–æ Stripe
3. **–°–µ–∫—Ä–µ—Ç–∏ –≤ env** ‚Äî –Ω–µ –≤ –∫–æ–¥—ñ
4. **HTTPS only** ‚Äî –Ω–∞ Render

---

**–°—Ç–∞—Ç—É—Å:** Production-ready! üöÄ
**–í–µ—Ä—Å—ñ—è:** v3.0.0
