# app/bot/handlers/buy.py
import os
from aiogram import Router, types, F
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton
from ...storage.db import upsert_user, get_user_by_id

router = Router()
BASE_URL = os.getenv("BASE_URL", "http://localhost:8000")

def confirmation_keyboard():
    """–ö–ª–∞–≤—ñ–∞—Ç—É—Ä–∞ –¥–ª—è –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –ø–µ—Ä–µ–¥ –æ–ø–ª–∞—Ç–æ—é"""
    return InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="üìú –ü—Ä–æ—á–∏—Ç–∞—Ç–∏ —É–º–æ–≤–∏ –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è", callback_data="show_refund")],
        [InlineKeyboardButton(text="‚úÖ –Ø –ø—Ä–æ—á–∏—Ç–∞–≤(–ª–∞) —Ç–∞ –ø–æ–≥–æ–¥–∂—É—é—Å—å", callback_data="confirm_purchase")],
        [InlineKeyboardButton(text="‚ùå –°–∫–∞—Å—É–≤–∞—Ç–∏", callback_data="cancel_purchase")]
    ])

def payment_keyboard(user_id: int):
    """–ö–ª–∞–≤—ñ–∞—Ç—É—Ä–∞ –∑ –ø–æ—Å–∏–ª–∞–Ω–Ω—è–º –Ω–∞ –æ–ø–ª–∞—Ç—É (–ø–µ—Ä–µ–¥–∞—î–º–æ tg_id)"""
    return InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="üí≥ –ü–µ—Ä–µ–π—Ç–∏ –¥–æ –æ–ø–ª–∞—Ç–∏", url=f"{BASE_URL}/pay?tg_id={user_id}")],
        [InlineKeyboardButton(text="üîô –ù–∞–∑–∞–¥", callback_data="back_to_main")]
    ])

@router.message(F.text == "/pay")
async def pay_cmd(m: types.Message):
    """–ö–æ–º–∞–Ω–¥–∞ /pay ‚Äî —à–≤–∏–¥–∫–∏–π –¥–æ—Å—Ç—É–ø –¥–æ –æ–ø–ª–∞—Ç–∏"""
    upsert_user(m.from_user.id, m.from_user.username)
    url = f"{BASE_URL}/pay?tg_id={m.from_user.id}"
    await m.answer(
        "üí≥ <b>–û–ø–ª–∞—Ç–∞ –∫—É—Ä—Å—É ¬´10 –∫—Ä–æ–∫—ñ–≤ –¥–æ —â–∞—Å—Ç—è¬ª</b>\n\n"
        "üîó –ü–µ—Ä–µ–π–¥—ñ—Ç—å –∑–∞ –ø–æ—Å–∏–ª–∞–Ω–Ω—è–º –¥–ª—è –æ–ø–ª–∞—Ç–∏ —á–µ—Ä–µ–∑ Stripe:\n"
        f"{url}\n\n"
        "–ü—ñ—Å–ª—è —É—Å–ø—ñ—à–Ω–æ—ó –æ–ø–ª–∞—Ç–∏ –≤–∏ –æ—Ç—Ä–∏–º–∞—î—Ç–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∑ —ñ–Ω–≤–∞–π—Ç-–ª—ñ–Ω–∫–æ–º –¥–æ –ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ –∫–∞–Ω–∞–ª—É.\n\n"
        "‚ö†Ô∏è –ü–µ—Ä–µ–¥ –æ–ø–ª–∞—Ç–æ—é –æ–∑–Ω–∞–π–æ–º—Ç–µ—Å—å –∑ —É–º–æ–≤–∞–º–∏: /legal"
    )

@router.callback_query(F.data=="buy")
async def buy_cb(cb: types.CallbackQuery):
    upsert_user(cb.from_user.id, cb.from_user.username)
    await cb.message.answer(
        "üí≥ <b>–ü—Ä–∏–¥–±–∞—Ç–∏ –∫—É—Ä—Å ¬´10 –∫—Ä–æ–∫—ñ–≤ –¥–æ —â–∞—Å—Ç—è¬ª</b>\n\n"
        "üì¶ <b>–©–æ –≤–∏ –æ—Ç—Ä–∏–º–∞—î—Ç–µ:</b>\n"
        "‚úÖ 10 —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–≤–∞–Ω–∏—Ö —É—Ä–æ–∫—ñ–≤\n"
        "‚úÖ –ü—Ä–∞–∫—Ç–∏—á–Ω—ñ –∑–∞–≤–¥–∞–Ω–Ω—è —Ç–∞ –∫–≤—ñ–∑–∏\n"
        "‚úÖ –î–æ—Å—Ç—É–ø –¥–æ –ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ –∫–∞–Ω–∞–ª—É\n"
        "‚úÖ –ü–æ–∂–∏—Ç—Ç—î–≤–∏–π –¥–æ—Å—Ç—É–ø\n\n"
        "üí∞ <b>–¶—ñ–Ω–∞:</b> 9,99 EUR (–æ–¥–Ω–æ—Ä–∞–∑–æ–≤–æ)\n\n"
        "‚ö†Ô∏è <b>–í–ê–ñ–õ–ò–í–û:</b> –ü–µ—Ä–µ–¥ –æ–ø–ª–∞—Ç–æ—é –≤–∏ –ø–æ–≤–∏–Ω–Ω—ñ –ø—Ä–æ—á–∏—Ç–∞—Ç–∏ —Ç–∞ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ —É–º–æ–≤–∏.",
        reply_markup=confirmation_keyboard()
    )
    await cb.answer()

async def show_purchase_warning(message: types.Message):
    """–ü–æ–∫–∞–∑—É—î –ø–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è –ø–µ—Ä–µ–¥ –ø–æ–∫—É–ø–∫–æ—é"""
    await message.answer(
        "üí≥ <b>–ü—Ä–∏–¥–±–∞—Ç–∏ –∫—É—Ä—Å ¬´10 –∫—Ä–æ–∫—ñ–≤ –¥–æ —â–∞—Å—Ç—è¬ª</b>\n\n"
        "üì¶ <b>–©–æ –≤–∏ –æ—Ç—Ä–∏–º–∞—î—Ç–µ:</b>\n"
        "‚úÖ 10 —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–≤–∞–Ω–∏—Ö —É—Ä–æ–∫—ñ–≤\n"
        "‚úÖ –ü—Ä–∞–∫—Ç–∏—á–Ω—ñ –∑–∞–≤–¥–∞–Ω–Ω—è —Ç–∞ –∫–≤—ñ–∑–∏\n"
        "‚úÖ –î–æ—Å—Ç—É–ø –¥–æ –ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ –∫–∞–Ω–∞–ª—É\n"
        "‚úÖ –ü–æ–∂–∏—Ç—Ç—î–≤–∏–π –¥–æ—Å—Ç—É–ø\n\n"
        "üí∞ <b>–¶—ñ–Ω–∞:</b> 9,99 EUR (–æ–¥–Ω–æ—Ä–∞–∑–æ–≤–æ)\n\n"
        "‚ö†Ô∏è <b>–í–ê–ñ–õ–ò–í–û:</b> –ü–µ—Ä–µ–¥ –æ–ø–ª–∞—Ç–æ—é –≤–∏ –ø–æ–≤–∏–Ω–Ω—ñ –ø—Ä–æ—á–∏—Ç–∞—Ç–∏ —Ç–∞ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ —É–º–æ–≤–∏.",
        reply_markup=confirmation_keyboard()
    )

@router.callback_query(F.data=="show_refund")
async def show_refund_policy(cb: types.CallbackQuery):
    """–ü–æ–∫–∞–∑—É—î –ø–æ–ª—ñ—Ç–∏–∫—É –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è –∫–æ—à—Ç—ñ–≤"""
    refund_text = """
‚õî <b>–ü–û–õ–Ü–¢–ò–ö–ê –ü–û–í–ï–†–ù–ï–ù–ù–Ø –ö–û–®–¢–Ü–í</b>

<b>–í–ê–ñ–õ–ò–í–û! –ü—Ä–æ—á–∏—Ç–∞–π—Ç–µ —É–≤–∞–∂–Ω–æ:</b>

‚ùå –ü–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è –∫–æ—à—Ç—ñ–≤ –ù–ï–ú–û–ñ–õ–ò–í–ï –ø—ñ—Å–ª—è –ø–æ–∫—É–ø–∫–∏
‚ùå –í—ñ–¥—Å—É—Ç–Ω—î –ø—Ä–∞–≤–æ –Ω–∞ –≤—ñ–¥–º–æ–≤—É
‚ùå –¶–µ —Ü–∏—Ñ—Ä–æ–≤–∏–π –ø—Ä–æ–¥—É–∫—Ç –∑ –º–∏—Ç—Ç—î–≤–∏–º –¥–æ—Å—Ç—É–ø–æ–º

<b>–ß–æ–º—É –Ω–µ–º–∞—î –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è?</b>
‚Ä¢ –í–∏ –æ—Ç—Ä–∏–º—É—î—Ç–µ –ù–ï–ì–ê–ô–ù–ò–ô –¥–æ—Å—Ç—É–ø –¥–æ –≤—Å—ñ—Ö 10 —É—Ä–æ–∫—ñ–≤
‚Ä¢ –¶–∏—Ñ—Ä–æ–≤–∏–π –∫–æ–Ω—Ç–µ–Ω—Ç –Ω–µ–º–æ–∂–ª–∏–≤–æ "–ø–æ–≤–µ—Ä–Ω—É—Ç–∏"
‚Ä¢ –¶–µ –ø–µ—Ä–µ–¥–±–∞—á–µ–Ω–æ –∑–∞–∫–æ–Ω–æ–¥–∞–≤—Å—Ç–≤–æ–º –Ñ–° (¬ß 356 BGB)

<b>–ü–µ—Ä–µ–¥ –ø–æ–∫—É–ø–∫–æ—é:</b>
‚úÖ –ü–µ—Ä–µ–≥–ª—è–Ω—å—Ç–µ –±–µ–∑–∫–æ—à—Ç–æ–≤–Ω–∏–π –≤—Å—Ç—É–ø–Ω–∏–π —É—Ä–æ–∫
‚úÖ –ü–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—è, —â–æ –≤–∞–º –ø—ñ–¥—Ö–æ–¥–∏—Ç—å —Ñ–æ—Ä–º–∞—Ç
‚úÖ –ü—Ä–æ—á–∏—Ç–∞–π—Ç–µ –≤—Å—ñ —é—Ä–∏–¥–∏—á–Ω—ñ –¥–æ–∫—É–º–µ–Ω—Ç–∏

<b>–ù–∞—Ç–∏—Å–∫–∞—é—á–∏ "–Ø –ø–æ–≥–æ–¥–∂—É—é—Å—å", –≤–∏ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂—É—î—Ç–µ:</b>
‚òëÔ∏è –Ø —Ä–æ–∑—É–º—ñ—é, —â–æ –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è –∫–æ—à—Ç—ñ–≤ –Ω–µ–º–æ–∂–ª–∏–≤–µ
‚òëÔ∏è –Ø –≤—ñ–¥–º–æ–≤–ª—è—é—Å—è –≤—ñ–¥ –ø—Ä–∞–≤–∞ –Ω–∞ –≤—ñ–¥–º–æ–≤—É
‚òëÔ∏è –Ø –ø–æ–≥–æ–¥–∂—É—é—Å—å –æ—Ç—Ä–∏–º–∞—Ç–∏ –Ω–µ–≥–∞–π–Ω–∏–π –¥–æ—Å—Ç—É–ø
‚òëÔ∏è –Ø –ø—Ä–æ—á–∏—Ç–∞–≤(–ª–∞) AGB —Ç–∞ Datenschutz
    """
    await cb.message.answer(refund_text, reply_markup=confirmation_keyboard())
    await cb.answer()

@router.callback_query(F.data=="confirm_purchase")
async def confirm_purchase(cb: types.CallbackQuery):
    """–ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –ø–æ–∫—É–ø–∫–∏ - –ø–æ–∫–∞–∑—É—î –ø–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ –æ–ø–ª–∞—Ç—É"""
    user_id = cb.from_user.id
    upsert_user(user_id, cb.from_user.username)
    
    await cb.message.answer(
        "‚úÖ <b>–î—è–∫—É—î–º–æ –∑–∞ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è!</b>\n\n"
        "–¢–µ–ø–µ—Ä –≤–∏ –º–æ–∂–µ—Ç–µ –ø–µ—Ä–µ–π—Ç–∏ –¥–æ –±–µ–∑–ø–µ—á–Ω–æ—ó –æ–ø–ª–∞—Ç–∏ —á–µ—Ä–µ–∑ Stripe.\n\n"
        "üîí –í–∞—à—ñ –ø–ª–∞—Ç—ñ–∂–Ω—ñ –¥–∞–Ω—ñ –∑–∞—Ö–∏—â–µ–Ω—ñ\n"
        "üí≥ –ü—Ä–∏–π–º–∞—é—Ç—å—Å—è –∫–∞—Ä—Ç–∫–∏ Visa, Mastercard —Ç–∞ —ñ–Ω—à—ñ\n"
        "üåç –ü—ñ–¥—Ç—Ä–∏–º–∫–∞ —Ä—ñ–∑–Ω–∏—Ö –≤–∞–ª—é—Ç\n\n"
        "–ü—ñ—Å–ª—è —É—Å–ø—ñ—à–Ω–æ—ó –æ–ø–ª–∞—Ç–∏ –≤–∏ –Ω–µ–≥–∞–π–Ω–æ –æ—Ç—Ä–∏–º–∞—î—Ç–µ –¥–æ—Å—Ç—É–ø –¥–æ –ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ –∫–∞–Ω–∞–ª—É.",
        reply_markup=payment_keyboard(user_id)
    )
    await cb.answer("‚úÖ –£–º–æ–≤–∏ –ø—Ä–∏–π–Ω—è—Ç—ñ")

@router.callback_query(F.data=="cancel_purchase")
async def cancel_purchase(cb: types.CallbackQuery):
    """–°–∫–∞—Å—É–≤–∞–Ω–Ω—è –ø–æ–∫—É–ø–∫–∏"""
    from ..keyboards.main_menu import main_menu
    await cb.message.edit_text(
        "‚ùå –ü–æ–∫—É–ø–∫—É —Å–∫–∞—Å–æ–≤–∞–Ω–æ.\n\n"
        "–í–∏ –º–æ–∂–µ—Ç–µ –ø–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—è –¥–æ –ø–æ–∫—É–ø–∫–∏ –≤ –±—É–¥—å-—è–∫–∏–π —á–∞—Å —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É ¬´üí≥ –ü—Ä–∏–¥–±–∞—Ç–∏ –∫—É—Ä—Å¬ª.\n\n"
        "–Ø–∫—â–æ —É –≤–∞—Å —î –ø–∏—Ç–∞–Ω–Ω—è, –Ω–∞–ø–∏—à—ñ—Ç—å –Ω–∞–º –∞–±–æ –ø–µ—Ä–µ–≥–ª—è–Ω—å—Ç–µ –±–µ–∑–∫–æ—à—Ç–æ–≤–Ω–∏–π –≤—Å—Ç—É–ø–Ω–∏–π —É—Ä–æ–∫.",
        reply_markup=main_menu()
    )
    await cb.answer("–°–∫–∞—Å–æ–≤–∞–Ω–æ")
